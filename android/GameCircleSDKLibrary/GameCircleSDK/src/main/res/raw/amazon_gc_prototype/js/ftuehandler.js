/*! Copyright 2013 Amazon Digital Services, Inc. All rights reserved. */
FTUEHandler=(function(){var a=function(o,r){var j=this;var e="ftue:connected";var c="user:guest";var x="user:cor";var u="FTUERequest";var B=3000;var f=false;var D=false;var d=true;var y=false;var E=false;var v={};var h=$.Deferred();var k=function(){var F=$.Deferred();j.getKindleInfo().always(function(G){console.log("FTUE reload state: checking device type");if(G.isKindle===true){E=false;console.log("FTUE reload state Kindle: checking account status and GC service readiness");if(G.isRegistered===true&&G.isGCServiceReady===true){console.log("FTUE reload state Kindle: checking opt-in state");if(G.hasOptedIn===true){console.log("FTUE reload state Kindle: connected");f=false;E=true;r.getFTUEConnected().always(function(H){if(H){D=false}else{D=true}});r.setGuestMode(false).always(function(){F.resolve()})}else{console.log("FTUE reload state Kindle: user has not opted-in")}}if(!E){console.log("FTUE reload state: couldn't connect to GC Service, return to guest mode");r.getFTUEConnected().always(function(H){if(H){l().always(function(){f=false;D=false;r.setGuestMode(true).always(function(){F.resolve()})})}else{f=false;D=false;r.setGuestMode(true).always(function(){F.resolve()})}})}}else{console.log("FTUE reload state: The device is not a kindle, so reset welcome toast status");j.setWelcomeToastShown(false);r.getUserCORSupport().always(function(H){if(H){r.setGlobalCORSupportLevel(H.supportLevel)}else{r.setGlobalCORSupportLevel(null)}var I=new CORSupportedResponse(H);d=I.isUnknown;y=I.isNotSupported;if(y){j.getLoggedInStatus().always(function(J){if(J){console.log("FTUE reload state: COR not supported");f=false;D=false;r.setGuestMode(true).always(function(){F.resolve()})}else{console.log("FTUE reload state: Unexpected logout, returning to guest mode.");A().always(function(){f=true;D=true;r.setGuestMode(true).always(function(){F.resolve()})})}})}else{r.getFTUEConnected().always(function(J){j.getLoggedInStatus().always(function(L){if(J){if(L){console.log("FTUE reload state: connected");f=false;D=false;r.setGuestMode(false).always(function(){F.resolve()})}else{console.log("FTUE reload state: Unexpected logout, returning to guest mode.");A().always(function(){f=true;D=true;r.setGuestMode(true).always(function(){F.resolve()})})}}else{var K;if(!d&&!L){K=r.setUserCORSupport(null);d=true;y=false}else{K=$.Deferred();K.resolve()}K.always(function(){console.log("FTUE reload state: guest");f=true;D=true;r.setGuestMode(true).always(function(){F.resolve()})})}})})}})}});return F.promise()};this["onInitialize"]=function(){var Q=$.Deferred();var K=$.Deferred();var F=ServiceFactory.getRequestFactory().createGetFeaturesUsageRequest(false,B);var I=ServiceFactory.getRequestRouter().handleRequest(F);var G=ServiceFactory.getRequestFactory().createGetAchievementsRequest(constants.NativeCallKeys.SELF_PLAYER_ID,false);var P=ServiceFactory.getRequestRouter().handleRequest(G);var N=ServiceFactory.getRequestFactory().createGetLeaderboardsForGameRequest("gameId",false);var L=ServiceFactory.getRequestRouter().handleRequest(N);var O=ServiceFactory.getRequestFactory().createGetTimePlayedXPCheckpointsRequest(B);var J=ServiceFactory.getRequestRouter().handleRequest(O);var M=ServiceFactory.getRequestFactory().createGetTimePlayedRequest();var H=ServiceFactory.getRequestRouter().handleRequest(M);k().always(function(){n().always(function(){K.resolve()});var R=$.Deferred();if(D){q().always(function(S){if(S){K.always(function(){s().always(function(T){R.resolve(T)})})}else{R.resolve(false)}})}else{R.resolve(false)}R.always(function(S){if(!S){K.always(function(){$.when(j.getKindleInfo(),r.getGuestMode(),I,H,J).always(function(ac,Z,X,ai,aj){if(Z){if(ac.isKindle){var ab=(ac.isRegistered===true&&ac.isGCServiceReady===true);w(ab)}else{if(f){var Y=$.Deferred();var W=$.Deferred();var U=$.Deferred();var T=$.Deferred();var ah=$.Deferred();var ag=$.Deferred();j.getLocaleInfo().always(function(ak){var al="";if(ak!==undefined&&ak!=null){al=ak[constants.NativeCallKeys.LANGUAGE_CODE]}Y.resolve(al)});r.getLastTimeUpsellAlertShown().always(function(ak){W.resolve(ak)});H.always(function(al){var am=0;if(al!==undefined&&al!==null){var ak=al.getResultMap();if(ak!==undefined&&ak!==null){am=ak.totalTimePlayed}}if(isNaN(am)){console.error("Invalid time played value detected: "+am);am=0}U.resolve(am)});var V=ServiceFactory.getRequestFactory().createGetAchievementsRequest(constants.NativeCallKeys.SELF_PLAYER_ID,true);var ae=ServiceFactory.getRequestRouter().handleRequest(V);ae.always(function(ak){var al=false;if(ak!==undefined&&ak!==null){var am=false;am=am||ak.getType()!==constants.NativeCallResultCode.SUCCESS;if(!am){var an=t(ak);if(an!==undefined&&an!==null&&an.length>0){al=true}}}T.resolve(al)});var af=ServiceFactory.getRequestFactory().createGetLeaderboardsForGameRequest("gameId",true);var aa=[];var ad=ServiceFactory.getRequestRouter().handleRequest(af);ad.always(function(ak){var an=false;if(ak!==undefined&&ak!==null){var al=false;al=al||ak.getType()!==constants.NativeCallResultCode.SUCCESS;if(!al){var am=m(ak);if(am!==undefined&&am!==null&&am.length>0){an=true}}}ah.resolve(an)});ServiceFactory.getExperiments().getTreatmentForExperiment("InitSigninAlertTest").always(function(ak){ag.resolve(ak)});$.when(Y,W,U,T,ah,ag).always(function(ar,av,aw,ao,at,au){var aq=false;var am=259200000;var al=600000;if(((av===undefined||av===null||av===0)||(((new Date().getTime())-av)>=am))&&(aw!==undefined&&aw!==null&&aw>=al)&&(ao||at)&&(au!==undefined&&au!==null&&!ServiceFactory.getExperiments().isTreatmentDefault(au)&&(au==="C"||au==="T1"))){aq=true}if(aq){if(au==="T1"){var an=new GameCircleEvent("ExperimentView");an.addAttribute(constants.MetricConstants.MetricStringValueAttributesKeys_TARGET_ID,"InitSigninAlertTest");an.addAttribute(constants.MetricConstants.MetricStringValueAttributesKeys_STATUS,au);an.close();r.setLastTimeUpsellAlertShown((new Date().getTime()));var ap=new GameCircleEvent("InitSigninAlertTestView");ap.close();if(at){j.showAlert(constants.OverlayActionCode.SHOW_LEADERBOARD_SIGN_IN_PROMPT)}else{j.showAlert(constants.OverlayActionCode.SHOW_ACHIEVEMENT_SIGN_IN_PROMPT)}}else{var ak=new GameCircleExperiment("InitSigninAlertTest",au,"InitSigninAlertTestView","InitSigninAlertTestConversion");b(ak)}}else{i()}})}else{i()}}}else{if(ac.isKindle){C(z(ai,aj))}else{C({})}}})})}Q.resolve()})});$.when(P,L,Q,K).always(function(W,U){var R=true;var T=true;if(W){var S=W.getResultMap();if(S.hasOwnProperty("serviceResult")){if(!S.achievements.achievements||S.achievements.achievements.length===0){R=false}}}if(U){var V=U.getResultMap();if(V.hasOwnProperty("serviceResult")){if(!V.LeaderboardList||V.LeaderboardList.length===0){T=false}}}ServiceFactory.getGCSettings().setAchievementsLeaderboardsExist(R,T);h.resolve()});return Q.promise()};var q=function(){var F=$.Deferred();j.getKindleInfo().always(function(G){console.log("FTUE: checking device type");if(G.isKindle===true){if(E){F.resolve(true)}else{F.resolve(false)}}else{setTimeout(function(){console.log("FTUE auto-connect failed: timed out");F.resolve(false)},2000);j.getNetworkInfo().always(function(H){var I=H!=null&&H[constants.NativeCallKeys.CONNECTED];if(!I){console.log("FTUE auto-connect failed: not online");F.resolve(false);return}j.getLoggedInStatus().always(function(J){if(!J){console.log("FTUE auto-connect failed: not logged in");F.resolve(false);return}$.when(o.getTOSAccepted(),g()).always(function(L,K){k().always(function(){if(!L||d||y){console.log("FTUE auto-connect failed: TOS:"+L+", COR blank:"+d+", COR not supported:"+y);F.resolve(false)}else{console.log("FTUE auto-connect checks passed");F.resolve(true)}})})})})}});return F.promise()};this["getInitializationPromise"]=function(){return h.promise()};this["showSignInPage"]=function(){var F=$.Deferred();r.getGuestMode().always(function(G){if(G){j.getLoggedInStatus().always(function(H){if(H){j.showOverlay(constants.OverlayActionCode.SHOW_TERMS_OF_SERVICE)}else{j.showOverlay(constants.OverlayActionCode.SHOW_LOGIN)}F.resolve()})}else{j.showOverlay(constants.OverlayActionCode.SHOW_SUMMARY);F.resolve()}});return F.promise()};this["authenticate"]=function(){j.getLoggedInStatus().always(function(F){var G;if(F){G=$.Deferred().resolve().promise()}else{G=j.showLoginPage()}G.always(function(){j.getLoggedInStatus().always(function(I){if(I){g().always(function(){k().always(function(){if(d){j.showOverlay(constants.OverlayActionCode.SHOW_COR_SELECTION)}else{if(y){j.showAlert(constants.OverlayActionCode.SHOW_COR_UNSUPPORTED)}else{s().always(function(J){if(J){j.notifyNativeOnLogIn()}})}}})});if(!F){var H=new GameCircleEvent("AmazonSignIn");H.addCount("LoginSuccess",1);H.close()}}else{var H=new GameCircleEvent("AmazonSignIn");H.addCount("LoginFailed",1);H.close()}})})})};this["updateCOR"]=function(F){p(F).always(function(){k().always(function(){if(d){var G=new GameCircleEvent("CORSelection");G.addAttribute(constants.MetricConstants.MetricStringValueAttributesKeys_COUNTRY,F);G.addCount("FailedToUpdateCOR",1);G.close();console.error("Failed to update COR.")}else{if(y){var G=new GameCircleEvent("CORSelection");G.addAttribute(constants.MetricConstants.MetricStringValueAttributesKeys_COUNTRY,F);G.addCount("CORNotSupported",1);G.close();j.showAlert(constants.OverlayActionCode.SHOW_COR_UNSUPPORTED)}else{var G=new GameCircleEvent("CORSelection");G.addAttribute(constants.MetricConstants.MetricStringValueAttributesKeys_COUNTRY,F);G.addCount("CORSuccess",1);G.close();s()}}})})};this["onSettingsChanged"]=function(){return k()};this["setOptIn"]=function(F){r.setOptIn(F).always(function(G){if(G!=null&&F){s()}})};this["startSession"]=function(){r.getPlayerId().always(function(F){if(F){console.log("FTUEHandler.startSession: PlayerId found.")}else{console.log("FTUEHandler.startSession: No player id.");n()}})};var t=function(F){var G=[];if(F instanceof Result){if(F.getType()===constants.NativeCallResultCode.SUCCESS){replyCode=constants.NativeCallResultCode.SUCCESS;var I=F.getResultMap()["achievements"];if(I!==undefined){var H=I.achievements;if(H!==undefined){$.each(H,function(L,M){var K={};var N=M.achievementMeta;var P=M.playerInfo||{};K.progress=P.progress;var J=N.largeIconUrl;var O=N.lockedLargeIconUrl;if(K.progress===100){K.image=J}else{K.image=O}if(P.unlocked){K.unlockdate=P.dateUnlocked}else{K.unlockdate=0}K.title=N.title;K.desc=N.description;K.hiddenValue=N.hiddenValue;G.push(K)})}}}}return G};var m=function(G){var H=[];var F=G.getResultMap()["LeaderboardList"];if(F!==undefined){$.each(F,function(N,L){var J={};var M=L.PercentileRank;var I=L.PlayerRank;var O=L.PlayerScore;var K=L.LeaderboardInfo;J.LEADERBOARD_ID=K.LeaderboardId;J.LEADERBOARD_NAME=K.Name;J.LEADERBOARD_DISPLAY_TEXT=K.DisplayText;J.LEADERBOARD_DATA_FORMAT=K.DataFormat;J.LEADERBOARD_ICON_URL=K.IconUrl;J.LEADERBOARD_POSITION=K.Position;J.LEADERBOARD_PERCENTILE_RANK=M;J.LEADERBOARD_PLAYER_RANK=I;J.LEADERBOARD_PLAYER_SCORE=O;H.push(J)})}return H};var i=function(){if(j.getWelcomeToastShown()){return}else{j.setWelcomeToastShown(true)}var F=ServiceFactory.getToastFactory().createWelcomeGuestToastRequest();j.showToast(F)};var b=function(F){if(j.getWelcomeToastShown()){return}else{j.setWelcomeToastShown(true)}var G=ServiceFactory.getToastFactory().createWelcomeGuestToastWithExperimentRequest(F);j.showToast(G)};var C=function(H){if(j.getWelcomeToastShown()){return}else{j.setWelcomeToastShown(true)}var L=ServiceFactory.getRequestFactory();var F=ServiceFactory.getRequestRouter();var K=true;var J=F.handleRequest(L.createGetProfileRequest(K));var I=F.handleRequest(L.createGetFeaturesUsageRequest(K));var G=j.getLocaleInfo();$.when(J,I,G).always(function(Q,U,O){var P=Q!==undefined?Q.getResultMap():null;var N=U!==undefined?U.getResultMap():null;var T="";if(P!==null){if(P.hidden===true){var M=O!==undefined&&O.length?O[0]:null;if(M!==undefined&&M!=null){var W=M[constants.NativeCallKeys.LANGUAGE_CODE];var S="US";T=StringsUtility.getString("profilepage_profile_is_hidden_2",W,S)}else{T=StringsUtility.getString("profilepage_profile_is_hidden_2","en",S)}}else{T=P.alias}}var V=[];if(N!==null&&N.featuresList!==undefined){for(var R=0;R<N.featuresList.length;R++){if(N.featuresList[R].featureEnabled){V.push(N.featuresList[R].featureId.toLowerCase())}}}j.showToast(ServiceFactory.getToastFactory().createWelcomeToastRequest(T,V,H))})};var w=function(G){if(j.getWelcomeToastShown()){return}else{j.setWelcomeToastShown(true)}var F=ServiceFactory.getToastFactory().createKindleWelcomeGuestToastRequest(G);j.showToast(F)};var g=function(){var F=$.Deferred();o.getCORSupported().always(function(H){var G=new CORSupportedResponse(H);d=G.isUnknown;y=G.isNotSupported;r.setUserCORSupport(H).always(function(){F.resolve()})});return F.promise()};var p=function(G){var F=$.Deferred();o.setCOR(G).always(function(){g().always(function(){F.resolve()})});return F.promise()};var n=function(){var F=$.Deferred();r.getGuestMode().always(function(G){if(!G){j.getNetworkInfo().always(function(H){var I=H!=null&&H[constants.NativeCallKeys.CONNECTED];if(I){o.getProfile(false,B,false).always(function(J){console.log("Profiles response: "+JSON.stringify(J));if(J!=null){r.setPlayerId(J.playerId).always(function(){r.setHiddenFlag(J.hidden).always(function(){F.resolve()})})}else{F.resolve()}})}else{F.resolve()}})}else{r.setPlayerId(null).always(function(){o.clearCachedProfile().always(function(){r.setHiddenFlag(null).always(function(){F.resolve()})})})}});return F.promise()};var s=function(){var F=$.Deferred();o.acceptTOS().always(function(){r.setFTUEConnected(true).always(function(){r.setWhispersyncEnabledUserSetting(true).always(function(){k().always(function(){var G=n();var J=j.getKindleInfo();var I=ServiceFactory.getRequestFactory().createGetTimePlayedXPCheckpointsRequest(B);var L=ServiceFactory.getRequestRouter().handleRequest(I);var H=ServiceFactory.getRequestFactory().createGetTimePlayedRequest();var K=ServiceFactory.getRequestRouter().handleRequest(H);r.getGuestMode().always(function(Q){if(!Q){var M=ServiceFactory.getRequestFactory().createClearAchievementsCacheRequest();var N=ServiceFactory.getRequestFactory().createClearLeaderboardsCacheRequest();var P=ServiceFactory.getRequestFactory().createClearProfilesCacheRequest();var O=ServiceFactory.getRequestRouter().handleRequest;$.when(O(M),O(N),O(P)).always(function(){$.when(L,K,J,G).always(function(R,V,S){if(h.isResolved()){var T={};T[constants.ProfilesBindingKeys.IS_SIGNED_IN_KEY]=true;NativeTransport.callNative({nativeCall:constants.NativeCallTypes.NOTIFY_SIGN_IN_STATE_CHANGE,args:T})}var U=new GameCircleEvent("GCConnect");U.close();if(S.isKindle){C(z(V,R))}else{C({})}F.resolve(true)})})}else{F.resolve(false)}})})})})});return F.promise()};var A=function(){var F=$.Deferred();r.setFTUEConnected(false).always(function(){r.setUserCORSupport(null).always(function(){r.setWhispersyncEnabledUserSetting(false).always(function(){var G={};G[constants.ProfilesBindingKeys.IS_SIGNED_IN_KEY]=false;NativeTransport.callNative({nativeCall:constants.NativeCallTypes.NOTIFY_SIGN_IN_STATE_CHANGE,args:G});F.resolve()})})});return F.promise()};var l=function(){var F=$.Deferred();r.setFTUEConnected(false).always(function(){r.setWhispersyncEnabledUserSetting(false).always(function(){var G={};G[constants.ProfilesBindingKeys.IS_SIGNED_IN_KEY]=false;NativeTransport.callNative({nativeCall:constants.NativeCallTypes.NOTIFY_SIGN_IN_STATE_CHANGE,args:G});F.resolve()})});return F.promise()};var z=function(N,M){var O={};if(N!==undefined&&M!==undefined&&!$.isEmptyObject(M)){var G=N.getResultMap()["totalTimePlayed"];if(G!==undefined&&G!==null&&!isNaN(G)&&G>0){var K=60;var L=1000;var J=Math.floor(G/L/K);var F=(M.hasOwnProperty("getResultMap"))?M.getResultMap():undefined;if(F&&F.length>0){var I=F[0]["checkpoints"];for(var H in I){if(I[H]["timePlayed"]>J){O.timeLeft=I[H]["timePlayed"]-J;O.xpToGain=I[H]["xp"];break}}}}}return O};this.getNetworkInfo=function(){return NativeTransport.callNative({nativeCall:constants.NativeCallTypes.GET_NETWORK_INFO})};this.getLocaleInfo=function(){return NativeTransport.callNative({nativeCall:constants.NativeCallTypes.GET_LOCALE_INFO})};this.getLoggedInStatus=function(){var G=NativeTransport.callNative({nativeCall:constants.NativeCallTypes.GET_LOGGED_IN_STATUS});var F=$.Deferred();G.always(function(I){var H=false;if(I!=null){isLoggedIn=I[constants.NativeCallKeys.LOGGED_IN_STATUS]}console.log("FTUE: isLoggedIn="+isLoggedIn);F.resolve(isLoggedIn)});return F.promise()};this.showLoginPage=function(){return NativeTransport.callNative({nativeCall:constants.NativeCallTypes.DO_LOGIN})};this.showToast=function(F){hostinterface.showToast(JSON.stringify(F))};this.showOverlay=function(F){var G={};G[constants.OverlayBindingKeys.OVERLAY_ACTION_CODE_KEY]=F;hostinterface.showOverlay(JSON.stringify(G))};this.showAlert=function(F){var G={};G[constants.OverlayBindingKeys.OVERLAY_ACTION_CODE_KEY]=F;hostinterface.showAlert(JSON.stringify(G))};this.setWelcomeToastShown=function(F){this.welcomeToastWasShown=F};this.getWelcomeToastShown=function(){if(typeof this.welcomeToastWasShown==="undefined"){return false}return this.welcomeToastWasShown};this.getKindleInfo=function(){var G=$.Deferred();var H=ServiceFactory.getSessionCache();var F=H.getKindleInfo();if(!F){$.when(r.isKindle(),r.isKindleRegistered(),r.isGCServiceReady(),r.hasOptedIn()).done(function(I,K,L,J){console.log("FTUE Kindle: isKindle="+I+", isRegistered="+K+", isGCServiceReady="+L+", hasOptedIn="+J);kindleInfo={isKindle:I,isRegistered:K,isGCServiceReady:L,hasOptedIn:J};H.setKindleInfo(kindleInfo);G.resolve(kindleInfo)})}else{$.when(r.isGCServiceReady()).done(function(I){F.isGCServiceReady=I;G.resolve(F)})}return G};this.notifyNativeOnLogIn=function(){var F={};F[constants.NativeCallKeys.JAVASCRIPT_EVENT_TYPE]=constants.JavascriptEventType.SIGN_IN_EVENT;return NativeTransport.callNative({nativeCall:constants.NativeCallTypes.NOTIFY_NATIVE,args:F})};this["getHandledType"]=function(){return u};this["handleRequest"]=function(K){var F=$.Deferred();if(!(K instanceof Request)){console.log("FTUEHandler: handleRequest: input was not of type Request");F.resolve(new Result(constants.NativeCallResultCode.REQUEST_ERROR,{}))}else{console.log("FTUEHandler: handleRequest: message is: "+JSON.stringify(K.getType()));var G=K.getType();var L=K.getParams();var I=L.action;var J={};switch(I){case"logout":var H=NativeTransport.callNative({nativeCall:constants.NativeCallTypes.DO_LOGOUT});H.always(function(){A().always(function(){k().always(function(){n().always(function(){F.resolve()})})})});break;case"login":j.showSignInPage();F.resolve();break;default:console.log("FTUEHandler: handleRequest: actionCode not supported: "+I);F.resolve(new Result(constants.NativeCallResultCode.REQUEST_ERROR,{}))}}console.log("FTUEHandler: handleRequest: end of call");return F.promise()}};return a}());console.log("FTUEHandler loaded.");