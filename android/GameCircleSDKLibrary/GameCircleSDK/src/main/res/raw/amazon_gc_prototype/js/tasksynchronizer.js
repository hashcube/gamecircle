/*! Copyright 2013 Amazon Digital Services, Inc. All rights reserved. */
var TaskSynchronizer=(function(){var a=5000;var e=1;var b=60000;var c=function(g,n,k){var m=false;var l=n;var j=k;var i=this;var f=null;var h=$.Deferred();if(!l||l<=1){l=e}if(!j||j<=0){j=a}this["hasLock"]=function(){return m};this["run"]=function(){m=true;l--;f=new Date().getTime();var o=$.Deferred();setTimeout(function(){var p=g(i);p.done(function(q){m=false;l=0;o.resolve(true,q)}).fail(function(q){m=false;o.reject(false,q)})},0);setTimeout(function(){o.reject(false)},j);return o};this["shouldRetry"]=function(){return l>0};this["isRunning"]=function(){return !!f};this["isPastGracePeriod"]=function(){if(!f){return false}var o=new Date().getTime();return o-f>=b+j};this["getTaskCompleteDfd"]=function(){return h}};var d=function(){var g=[];var i=function(){return g.length==0};var f=0;var h=function(){if(!i()){var k=g[0];var j=k.run();j.always(function(n,l){if(k===g[0]){g.shift();if(k.shouldRetry()){g.push(k)}else{if(n){k.getTaskCompleteDfd().resolve(l)}else{k.getTaskCompleteDfd().reject(l)}}h()}else{console.error("TaskSynchronizer may be running multiple tasks in parallel");if(n){k.getTaskCompleteDfd().resolve(l);var m=g.indexOf(k);if(~m){g.splice(m,1)}}}})}};this["runTask"]=function(k,m,n){if(typeof k!=="function"){console.error("Bad argument passed to TaskSynchronizer.runTask: "+k);return null}var j=i();var l=new c(k,m,n);g.push(l);if(j){h()}else{if(g[0].isPastGracePeriod()){console.error("Task runner stalled: Discarding current task and restarting it");g.shift();h()}else{if(!g[0].isRunning()){h()}}}return l.getTaskCompleteDfd().promise()}};return d})();